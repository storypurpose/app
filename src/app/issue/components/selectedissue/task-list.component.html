<div *ngIf="loading">
    <fa-icon icon="spinner" [spin]="true" aria-hidden="true" class="mr-1"></fa-icon> loading...
</div>
<div *ngIf="issue && !loading">
    <div class="alert bg-light pl-0 mb-0" style="font-size:medium;" *ngIf="showIssue">

        <app-issue-navigation-menu class="float-right" [issueKey]="issue.key"></app-issue-navigation-menu>

        <button class="btn btn-sm btn-link mr-2" (click)="onClose()">
            <fa-icon icon="chevron-left" size="lg"></fa-icon>
        </button>
        <span class="pt-2">
            <span class="mr-1" [ngClass]="{'issue-resolved': issue.resolution}">{{issue.key}}:</span>
            {{issue.title}}
        </span>
        <button class="btn btn-link btn-sm" *ngIf="issue.description && issue.description.length > 0"
            (click)="hideDetails = !hideDetails">
            {{(hideDetails ? "more ..." : "... less") }}
        </button>
        <div class="small p-4" [ngbCollapse]="hideDetails">
            <ngx-md [data]="issue.description"></ngx-md>
        </div>
    </div>

    <div *ngIf="filteredItems && filteredItems.length > 0">

        <!-- <button class="btn btn-link btn-sm" *ngIf="!hasExtendedFields">
            <fa-icon icon="question-circle" size="sm"></fa-icon>
            Did you know?
        </button> -->

        <div class="list-group list-group-flush list-group-flush-compact">
            <div class="list-group-item list-group-item-light">
                <div class="clearfix">
                    <!-- <button *ngIf="hasExtendedFields" (click)="showHideExtendedFields()"
                        class="btn btn-sm btn-link text-muted pl-0" title="Show/hide details">
                        <fa-icon size="sm" [fixedWidth]="true"
                            [icon]="hideExtendedFields ? 'angle-double-right' : 'angle-double-down'">
                        </fa-icon>
                    </button> -->

                    <b class="mt-1"><span class="mr-1" *ngIf="filteredItems.length > 0">
                            {{filteredItems.length}} </span>
                        record{{(filteredItems.length > 1 ? 's' : '')}}</b>

                    <button (click)="tasklistFilterVisible = !tasklistFilterVisible"
                        *ngIf="((issueTypeStats && issueTypeStats.length > 1) || statusStats && statusStats.length > 1)"
                        class="btn btn-link btn-sm float-right" title="Filters">
                        <fa-icon size="sm" [icon]="tasklistFilterVisible ? 'chevron-up' : 'filter'"></fa-icon>
                    </button>
                </div>
                <div class="row" [ngbCollapse]="!tasklistFilterVisible">
                    <div class="col-md-6" *ngIf="issueTypeStats && issueTypeStats.length > 1">
                        <select class="form-control form-control-sm" [(ngModel)]="issueTypeFilter"
                            (change)="onFilterChanged()">
                            <option value="all">ISSUE TYPE: All</option>
                            <option *ngFor="let it of issueTypeStats" [value]="it.key">
                                {{it.key + '  (' + it.count + ')'}}</option>
                        </select>
                    </div>
                    <div class="col-md-6" *ngIf="statusStats && statusStats.length > 1">
                        <select class="form-control form-control-sm" [(ngModel)]="statusFilter"
                            (change)="onFilterChanged()">
                            <option value="all">STATUS: All</option>
                            <option *ngFor="let status of statusStats" [value]="status.key">
                                {{status.key + '  (' + status.count + ')'}}</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class=" p-1 border-bottom" *ngFor="let record of filteredItems;let idx = index">
                <div class="float-left mr-2">
                    <!-- <button *ngIf="hasExtendedFields" (click)="record.hideExtendedFields = !record.hideExtendedFields"
                        class="btn btn-link btn-sm text-muted pl-0 pt-0" title="Show/hide details">
                        <fa-icon size="sm" [fixedWidth]="true"
                            [icon]="record.hideExtendedFields ? 'angle-right' : 'angle-down'">
                        </fa-icon>
                    </button> -->
                    <a (click)="openIssueAtIndex(idx)" class="text-primary"
                        [ngClass]="{'issue-resolved': record.resolution}">
                        <fa-icon icon="external-link-alt" size="sm"></fa-icon>
                        {{record.key}}
                    </a>
                </div>

                <div class="badge badge-light font-weight-light text-uppercase float-right ">
                    {{record.status}}
                </div>
                <div [ngClass]="{'ml-4': hasExtendedFields}">
                    <div class=" text-no-wrap">{{record.title}}</div>
                    <div style="overflow: auto;" class="alert mt-2 p-0 rounded-0 border-0"
                        *ngIf="!record.hideExtendedFields && record.extendedFields && record.extendedFields.length > 0">
                        <table class="table table-small m-0 border-0 bg-light extended-fields">
                            <tr *ngFor="let ef of record.extendedFields">
                                <td class="p-1 text-nowrap text-muted" width="10%">{{ef.name}}:</td>
                                <td class="p-1 text-dark" Markdown>
                                    {{ef.value}}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="alert alert-warning mt-2" *ngIf="filteredItems && filteredItems.length === 0">
        No detail records found.
    </div>
</div>

<p-sidebar [(visible)]="issueDetailsVisible" [fullScreen]="true" styleClass="bg-light" [showCloseIcon]="false">
    <app-issue-details [list]="filteredItems" [currentIndex]="currentIndex" (close)="issueDetailsVisible = false"></app-issue-details>
</p-sidebar>